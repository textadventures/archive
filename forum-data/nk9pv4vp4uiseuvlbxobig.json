{
  "Topic": {
    "TopicId": "nk9pv4vp4uiseuvlbxobig",
    "ForumId": "10",
    "Title": "Map Breaks After Moving Too Fast",
    "LastUpdated": "2024-04-22T08:18:07.8548216Z",
    "ReplyCount": 0
  },
  "Posts": [
    {
      "PostId": "46bccb3c-dc98-4492-a932-6183ee4ba7b8",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "When the player moves from room to room too quickly, this can sometimes break the map when one of the destinations is an unexplored room. The map stops updating and the yellow dot representing the player no longer changes position. I'm currently trying to fix this with the following code:\r\n\r\n```\r\n  JS.Grid_ClearAllLayers ()\r\n  Grid_Redraw\r\n  Grid_DrawPlayerInRoom (game.pov.parent)\r\n```\r\nThis seems to redraw the map properly but it fails to reenable the player indicator's movement; the indicator will remain in place even though the map's focus will move to the new room. What can I do to refresh the indicator?",
      "EditableFormat": "markdown",
      "HTML": "<p>When the player moves from room to room too quickly, this can sometimes break the map when one of the destinations is an unexplored room. The map stops updating and the yellow dot representing the player no longer changes position. I'm currently trying to fix this with the following code:</p>\n<pre><code>  JS.Grid_ClearAllLayers ()\n  Grid_Redraw\n  Grid_DrawPlayerInRoom (game.pov.parent)\n</code></pre>\n<p>This seems to redraw the map properly but it fails to reenable the player indicator's movement; the indicator will remain in place even though the map's focus will move to the new room. What can I do to refresh the indicator?</p>\n\n",
      "PostDate": "2024-04-22T08:18:07.8548216Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "75c7e1c0-a118-4296-b540-cc16636232b3",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "When you say \"moves too quickly\", do you mean number of moves, or distance? I can see a possible issue if the player moves again while the previous movement is still being animated; and a different one which could crop up if the player teleports to a room a very large distance away.\r\n\r\nI think the second case is probably handled correctly by grid.js, because I think one of my games would have struggled with it otherwise. So you're probably referring to a rapid-fire series of normal-length moves. But would be good to clarify.",
      "EditableFormat": "markdown",
      "HTML": "<p>When you say \"moves too quickly\", do you mean number of moves, or distance? I can see a possible issue if the player moves again while the previous movement is still being animated; and a different one which could crop up if the player teleports to a room a very large distance away.</p>\n<p>I think the second case is probably handled correctly by grid.js, because I think one of my games would have struggled with it otherwise. So you're probably referring to a rapid-fire series of normal-length moves. But would be good to clarify.</p>\n\n",
      "PostDate": "2024-04-22T09:12:11.6520991Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "24d8d042-b8e8-4ac6-9a03-c92d471c1317",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Yes, I think the first case might be what the issue is. It's not something I can reliably reproduce either, so I think latency might play a factor as well.",
      "EditableFormat": "markdown",
      "HTML": "<p>Yes, I think the first case might be what the issue is. It's not something I can reliably reproduce either, so I think latency might play a factor as well.</p>\n\n",
      "PostDate": "2024-04-22T11:26:10.6739906Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "e8fe07b2-a037-4b0f-9356-93ae5a16736a",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I've gone through the code by hand, and didn't see the particular error I expected to find based on your description of the issue.\r\nCan you check if there are any messages in the JS console (Ctrl+Shift+J on Chrome; not sure about other browsers) when this happens?\r\n\r\nIf the player object is falling off the list of objects for the current layer, moving it should re-add it; which makes me wonder if onFrame is failing to run; but then I think that clearing the screen wouldn't start it again. Unless the issue is that some object in the redraw queue is corrupt, meaning that it generates an error on every redraw until it's removed by clearing the screen. This would likely always affect the player object, because gridApi.drawPlayer moves the player circle to the end of the queue, to ensure it appears on top of all the rooms.\r\n\r\nBut it's hard to say more… if there's an error message, I think that would help.",
      "EditableFormat": "markdown",
      "HTML": "<p>I've gone through the code by hand, and didn't see the particular error I expected to find based on your description of the issue.<br>\nCan you check if there are any messages in the JS console (Ctrl+Shift+J on Chrome; not sure about other browsers) when this happens?</p>\n<p>If the player object is falling off the list of objects for the current layer, moving it should re-add it; which makes me wonder if onFrame is failing to run; but then I think that clearing the screen wouldn't start it again. Unless the issue is that some object in the redraw queue is corrupt, meaning that it generates an error on every redraw until it's removed by clearing the screen. This would likely always affect the player object, because gridApi.drawPlayer moves the player circle to the end of the queue, to ensure it appears on top of all the rooms.</p>\n<p>But it's hard to say more… if there's an error message, I think that would help.</p>\n\n",
      "PostDate": "2024-04-22T12:27:13.3015421Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "861902df-5d84-42e0-82eb-c97d3fe5ad95",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I actually can't reproduce this issue in the browser version. From what I can tell, the compass won't register input until the player has finished moving to the next room on that platform, so rapidly moving between rooms isn't possible. In the desktop client, however, this wait doesn't exist. For instance, I can stack up three clicks north before I've moved to the next room, and it will send me three rooms north. This different behavior seems to be where the bug is rooted.",
      "EditableFormat": "markdown",
      "HTML": "<p>I actually can't reproduce this issue in the browser version. From what I can tell, the compass won't register input until the player has finished moving to the next room on that platform, so rapidly moving between rooms isn't possible. In the desktop client, however, this wait doesn't exist. For instance, I can stack up three clicks north before I've moved to the next room, and it will send me three rooms north. This different behavior seems to be where the bug is rooted.</p>\n\n",
      "PostDate": "2024-04-22T13:09:18.3478874Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "ba206138-177f-4781-b8f7-8368310f1ef6",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Oh, and I just realized that I should clarify that I'm using version 5.8 for my game, not 6.",
      "EditableFormat": "markdown",
      "HTML": "<p>Oh, and I just realized that I should clarify that I'm using version 5.8 for my game, not 6.</p>\n\n",
      "PostDate": "2024-04-22T13:13:04.1810666Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "65c1298b-a5f6-466f-aa02-758aae2d5186",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hmm… I suspect that the lag on the web version would make it impossible to move that fast. Unless you have a huge map, I guess. What about if you use multiple commands? (like entering \"north.north.east.north\" if your game supports it)\r\n\r\nI don't have the desktop version here, so debugging will be pretty hard if I can't replicate the problem.\r\nI'll try a couple of ideas to see if I can make this work on the web version; but I'm really not sure about the nature of the issue.",
      "EditableFormat": "markdown",
      "HTML": "<p>Hmm… I suspect that the lag on the web version would make it impossible to move that fast. Unless you have a huge map, I guess. What about if you use multiple commands? (like entering \"north.north.east.north\" if your game supports it)</p>\n<p>I don't have the desktop version here, so debugging will be pretty hard if I can't replicate the problem.<br>\nI'll try a couple of ideas to see if I can make this work on the web version; but I'm really not sure about the nature of the issue.</p>\n\n",
      "PostDate": "2024-04-23T09:01:17.928842Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "4c387e12-caef-4b40-bbe1-32d41a38233d",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hmm, I can't get multiple commands to work like that. Is there a way to enable that?",
      "EditableFormat": "markdown",
      "HTML": "<p>Hmm, I can't get multiple commands to work like that. Is there a way to enable that?</p>\n\n",
      "PostDate": "2024-04-24T01:19:12.2169705Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "ec989ffb-b1e4-4d29-8679-8e80ad0b7e31",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I think there's a box to tick somewhere in the game settings.",
      "EditableFormat": "markdown",
      "HTML": "<p>I think there's a box to tick somewhere in the game settings.</p>\n\n",
      "PostDate": "2024-04-25T10:37:03.6165866Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "38b87913-d510-4f38-a881-639ba3451d1b",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Following up on this, I managed to give this some thorough testing and the issue doesn't occur when entering multiple commands, either on browser or on desktop. It appears to only occur when using the Navigation compass on desktop.",
      "EditableFormat": "markdown",
      "HTML": "<p>Following up on this, I managed to give this some thorough testing and the issue doesn't occur when entering multiple commands, either on browser or on desktop. It appears to only occur when using the Navigation compass on desktop.</p>\n\n",
      "PostDate": "2024-05-18T06:31:00.8451665Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "700ee497-439a-401f-b10d-25d672595d09",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Okay… all the compass buttons do is send a normal command; entering a direction name into the command bar and sending it. So I can only assume that the issue is with sending another movement command while the map is still scrolling. I'm guessing that the reason I can't replicate this on web is that the lag between my browser and the server is long enough to stop me sending commands that quickly.\r\n\r\nAnd I just compared the code for the `sendCommand` function in `desktopplayer.js` and `player.js` … interesting discovery there.\r\n\r\nThe version in `player.js`, used when playing on the web, uses a boolean `canSendCommand` to track whether it's waiting for a response from the server for the last command sent, and if so won't send another command. This means that the rate at which clicks can be passed through is limited by the lag between the player and the server. But the version in `desktopplayer.js` only does this check for verb buttons, verb menus, command links, and the command bar - not compass buttons.\r\n\r\nI'm not sure if there's a check somewhere else that I'm missing, but it seems to me that if the `go` command takes a little while to run, it would be possible to run a second copy of the command before the first one had finished. This doesn't seem like a good idea to me…",
      "EditableFormat": "markdown",
      "HTML": "<p>Okay… all the compass buttons do is send a normal command; entering a direction name into the command bar and sending it. So I can only assume that the issue is with sending another movement command while the map is still scrolling. I'm guessing that the reason I can't replicate this on web is that the lag between my browser and the server is long enough to stop me sending commands that quickly.</p>\n<p>And I just compared the code for the <code>sendCommand</code> function in <code>desktopplayer.js</code> and <code>player.js</code> … interesting discovery there.</p>\n<p>The version in <code>player.js</code>, used when playing on the web, uses a boolean <code>canSendCommand</code> to track whether it's waiting for a response from the server for the last command sent, and if so won't send another command. This means that the rate at which clicks can be passed through is limited by the lag between the player and the server. But the version in <code>desktopplayer.js</code> only does this check for verb buttons, verb menus, command links, and the command bar - not compass buttons.</p>\n<p>I'm not sure if there's a check somewhere else that I'm missing, but it seems to me that if the <code>go</code> command takes a little while to run, it would be possible to run a second copy of the command before the first one had finished. This doesn't seem like a good idea to me…</p>\n\n",
      "PostDate": "2024-05-19T12:59:58.7368131Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "bfadeee1-25f3-45be-8d61-67e94bff802b",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Yes, this seems to line up with my experience of the issue. Is there a way I can get around this, like with a JS script or some such?",
      "EditableFormat": "markdown",
      "HTML": "<p>Yes, this seems to line up with my experience of the issue. Is there a way I can get around this, like with a JS script or some such?</p>\n\n",
      "PostDate": "2024-05-21T09:57:59.0982931Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "cfb23eaa-07a9-4af5-99f5-d3b9cad9104b",
      "UserId": 187141,
      "Username": "Shadecerule",
      "AvatarUrl": "https://secure.gravatar.com/avatar/c73b5bde1f86d7098461d3f9889a386f?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Just giving this thread a little bump since it's been a while.",
      "EditableFormat": "markdown",
      "HTML": "<p>Just giving this thread a little bump since it's been a while.</p>\n\n",
      "PostDate": "2024-06-08T07:50:29.8073781Z",
      "LastEditDate": null,
      "link": null
    }
  ]
}
