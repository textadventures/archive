{
  "Topic": {
    "TopicId": "49oa9in7a0wpfgs24blmpq",
    "ForumId": "10",
    "Title": "ShopLib error when typing 'buy' in the shop",
    "LastUpdated": "2022-12-09T17:37:19.7081126Z",
    "ReplyCount": 0
  },
  "Posts": [
    {
      "PostId": "3ac5ba6e-505f-4916-992e-2b08eb23b15f",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hi there,\r\n\r\nI have followed the tutorial to create a shop (created a room, and then a stock room inside, then added an object attribute in the shop for 'shopstock', and set it to the stock room.\r\n\r\nI then created an item in the stock room, and set its price in the 'inventory' tab.\r\n\r\nWhen I type 'buy' in the shop, however, I get this error and the price of the item just reads '0 gold pieces':\r\n'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100': ArithmeticElement: Operation 'Add' is not defined for types 'Int32' and 'Object'\r\nItem to purchase (have 0 gold pieces)'\r\n\r\nMy thinking is that ShopLib is having difficulty presenting the price for the item, and this is causing the error.\r\n\r\nAm I doing something wrong?\r\n\r\nThanks",
      "EditableFormat": "markdown",
      "HTML": "<p>Hi there,</p>\n<p>I have followed the tutorial to create a shop (created a room, and then a stock room inside, then added an object attribute in the shop for 'shopstock', and set it to the stock room.</p>\n<p>I then created an item in the stock room, and set its price in the 'inventory' tab.</p>\n<p>When I type 'buy' in the shop, however, I get this error and the price of the item just reads '0 gold pieces':<br>\n'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100': ArithmeticElement: Operation 'Add' is not defined for types 'Int32' and 'Object'<br>\nItem to purchase (have 0 gold pieces)'</p>\n<p>My thinking is that ShopLib is having difficulty presenting the price for the item, and this is causing the error.</p>\n<p>Am I doing something wrong?</p>\n<p>Thanks</p>\n\n",
      "PostDate": "2022-12-09T17:37:19.7081126Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "99acb311-aa1b-4367-9191-1e14bd96b474",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I haven't used ShopLib, but I know how to read error messages.\r\n\r\n> 'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100'\r\n\r\nThis tells you that there is an error in the expression quoted\r\n\r\n> ArithmeticElement: Operation 'Add' is not defined for types 'Int32' and 'Object'\r\n\r\nThe expression is failing because it's trying to add an Int32 (a whole number) to an Object (which isn't a number, so it doesn't make sense to try addition on it)\r\n\r\nThe only addition in the expression is `(rate + game.pov.parent.markup)` … which tells us that `rate` is a number (good), and `game.pov.parent.markup` is an object.\r\n\r\nAs far as unpacking that…\r\n`game` is the special object representing the game\r\n`game.pov` is an attribute pointing to the object the player is currently controlling\r\n`game.pov.parent` is the room that `game.pov` is currently in (presumably the shop)\r\n\r\nSo… this script expects shops to have an attribute named `markup` with a numeric value. I'd guess it means how much that shop marks up the prices by. So try giving the shop a markup attribute, and see if it works.\r\n\r\n(The reason it says \"Object\" is that the special value `null` (which means \"no such attribute\") is technically an object)",
      "EditableFormat": "markdown",
      "HTML": "<p>I haven't used ShopLib, but I know how to read error messages.</p>\n<blockquote>\n<p>'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100'</p>\n</blockquote>\n<p>This tells you that there is an error in the expression quoted</p>\n<blockquote>\n<p>ArithmeticElement: Operation 'Add' is not defined for types 'Int32' and 'Object'</p>\n</blockquote>\n<p>The expression is failing because it's trying to add an Int32 (a whole number) to an Object (which isn't a number, so it doesn't make sense to try addition on it)</p>\n<p>The only addition in the expression is <code>(rate + game.pov.parent.markup)</code> … which tells us that <code>rate</code> is a number (good), and <code>game.pov.parent.markup</code> is an object.</p>\n<p>As far as unpacking that…<br>\n<code>game</code> is the special object representing the game<br>\n<code>game.pov</code> is an attribute pointing to the object the player is currently controlling<br>\n<code>game.pov.parent</code> is the room that <code>game.pov</code> is currently in (presumably the shop)</p>\n<p>So… this script expects shops to have an attribute named <code>markup</code> with a numeric value. I'd guess it means how much that shop marks up the prices by. So try giving the shop a markup attribute, and see if it works.</p>\n<p>(The reason it says \"Object\" is that the special value <code>null</code> (which means \"no such attribute\") is technically an object)</p>\n\n",
      "PostDate": "2022-12-09T22:10:51.7366386Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "776fd06a-27cb-4b2a-847b-df32f13b723d",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hi,\r\n\r\nThanks for the breakdown, much appreciated.\r\n\r\nI have added a markup attribute to the shop, and set it to an integer.\r\n\r\nWhen I attempt to use the 'buy' command in the text box, I now get this error:\r\n\r\n'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100': ArithmeticElement: Operation 'Multiply' is not defined for types 'Element' and 'Int32'\r\nItem to purchase (have 0 gold pieces)'.\r\n\r\nThe first part of the error appears the same as before, but the latter includes the new 'Multiply' operation.",
      "EditableFormat": "markdown",
      "HTML": "<p>Hi,</p>\n<p>Thanks for the breakdown, much appreciated.</p>\n<p>I have added a markup attribute to the shop, and set it to an integer.</p>\n<p>When I attempt to use the 'buy' command in the text box, I now get this error:</p>\n<p>'Error running script: Error compiling expression 'price * (rate + game.pov.parent.markup) / 100': ArithmeticElement: Operation 'Multiply' is not defined for types 'Element' and 'Int32'<br>\nItem to purchase (have 0 gold pieces)'.</p>\n<p>The first part of the error appears the same as before, but the latter includes the new 'Multiply' operation.</p>\n\n",
      "PostDate": "2022-12-13T10:29:43.7202363Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "18e1fd8d-25d8-4f18-820b-d441e6807a2a",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I'd guess the problem is now with the `price` variable. I'll try to look at the library when I get to my computer, and see where that comes from.",
      "EditableFormat": "markdown",
      "HTML": "<p>I'd guess the problem is now with the <code>price</code> variable. I'll try to look at the library when I get to my computer, and see where that comes from.</p>\n\n",
      "PostDate": "2022-12-14T08:32:01.9138614Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "e8cb4b35-8126-4056-893a-cf02f67ea20c",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hi, I'm still stuck on this. Wondered if anyone had a solution?\r\n\r\nThanks!",
      "EditableFormat": "markdown",
      "HTML": "<p>Hi, I'm still stuck on this. Wondered if anyone had a solution?</p>\n<p>Thanks!</p>\n\n",
      "PostDate": "2023-01-01T16:20:03.6496743Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "21ae71ce-ec38-4b0e-a45a-b77cccde4d40",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "The version of ShopLib I can find doesn't include the lines of code shown in your error message. There's no reference to a `markup` variable.\r\n\r\nHave you modified the `BuyingPrice` function? Or can you give a link to the version of ShopLib you are using?",
      "EditableFormat": "markdown",
      "HTML": "<p>The version of ShopLib I can find doesn't include the lines of code shown in your error message. There's no reference to a <code>markup</code> variable.</p>\n<p>Have you modified the <code>BuyingPrice</code> function? Or can you give a link to the version of ShopLib you are using?</p>\n\n",
      "PostDate": "2023-01-01T23:07:41.4102736Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "ba2c03bb-4904-440b-b393-3bab17bbd529",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Oh, that's weird. I haven't modified the BuyingPrice function, just installed the library as normal.\r\n\r\nThis is the version I have been using, as linked on The Pix's Github page, originally following the links from the text adventure documentation page:\r\n\r\nhttps://github.com/ThePix/quest/blob/master/ShopLib.aslx",
      "EditableFormat": "markdown",
      "HTML": "<p>Oh, that's weird. I haven't modified the BuyingPrice function, just installed the library as normal.</p>\n<p>This is the version I have been using, as linked on The Pix's Github page, originally following the links from the text adventure documentation page:</p>\n<p>https://github.com/ThePix/quest/blob/master/ShopLib.aslx</p>\n\n",
      "PostDate": "2023-01-03T08:31:48.730789Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "952ad73b-6c9b-445d-a7fe-df8e4d09d940",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Yeah… the expression `price * (rate + game.pov.parent.markup) / 100` is not on that page.\r\n\r\nI would expect to see an expression like that if someone had modified the library to include shops which charge more than others (although in that case, I would expect it to be <code style=\"color: green\"><b>obj.</b>price * (rate + game.pov.parent.markup) / 100</code>).\r\n\r\nSee if you can find it in the function `BuyingPrice`. If not, try searching your game for that expression; or search for it in your copy of the library. I'm not sure if the offline editor has a search function; if not, you could open the .aslx file in Notepad or similar and just search for that piece of code.\r\n\r\nIf we can see the function that includes that expression, it would be easier to work out what's wrong with it.",
      "EditableFormat": "markdown",
      "HTML": "<p>Yeah… the expression <code>price * (rate + game.pov.parent.markup) / 100</code> is not on that page.</p>\n<p>I would expect to see an expression like that if someone had modified the library to include shops which charge more than others (although in that case, I would expect it to be <code style=\"color: green\"><b>obj.</b>price * (rate + game.pov.parent.markup) / 100</code>).</p>\n<p>See if you can find it in the function <code>BuyingPrice</code>. If not, try searching your game for that expression; or search for it in your copy of the library. I'm not sure if the offline editor has a search function; if not, you could open the .aslx file in Notepad or similar and just search for that piece of code.</p>\n<p>If we can see the function that includes that expression, it would be easier to work out what's wrong with it.</p>\n\n",
      "PostDate": "2023-01-03T10:25:30.3121984Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "7d62c284-aeb3-46c1-b8bd-bc80e1b31173",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Okay. I should start by saying this is fixed now. Huzzah!\r\n\r\nThe short answer: I uninstalled and reinstalled the ShopLib library. I don't know how I missed something this simple, but this was the solution. Before trying this, though, I did some investigating into the BuyingPrice function, and found the expression in question. Out of interest, I wonder how this conflicted with ShopLib before reinstalling it.\r\n\r\nThe 'BuyingPrice' function was in 'Items.xml', one of 9 extra files that come with CombatLib.aslx in the install zip file:\r\n\r\n```<function name=\"BuyingPrice\" parameters=\"price\" type=\"int\"><![CDATA[\r\n      if (game.pov.status = \"Merchant's Tongue\") {\r\n        rate = 75\r\n      }\r\n      else {\r\n        rate = 100\r\n      }\r\n      return (price * (rate + game.pov.parent.markup) / 100)\r\n  ]]></function>```\r\n\r\n  <!--\r\n  Sets the mark up for selling goods across the world to be their price attribute.\r\n  -->\r\n  <function name=\"SellingPrice\" parameters=\"price\" type=\"int\"><![CDATA[\r\n      if (game.pov.status = \"Merchant's Tongue\") {\r\n        rate = 125\r\n      }\r\n      else {\r\n        rate = 100\r\n      }\r\n      return (price * (rate - game.pov.parent.markup) / 200)\r\n  ]]></function>\r\n\r\nI had thought, when comparing this to ShopLib's aslx file, that CombatLib maybe had its own shop code, and so ShopLib wasn't needed. I uninstalled ShopLib and made a shop but the 'buy' command did nothing, so I reinstalled ShopLib, thinking I could copy the BuyingPrice code from ShopLib's aslx to overwrite that in CombatLib's. But I didn't need to in the end.\r\n\r\nThanks for all your help with this. Can't believe it was such a simple solution!",
      "EditableFormat": "markdown",
      "HTML": "<p>Okay. I should start by saying this is fixed now. Huzzah!</p>\n<p>The short answer: I uninstalled and reinstalled the ShopLib library. I don't know how I missed something this simple, but this was the solution. Before trying this, though, I did some investigating into the BuyingPrice function, and found the expression in question. Out of interest, I wonder how this conflicted with ShopLib before reinstalling it.</p>\n<p>The 'BuyingPrice' function was in 'Items.xml', one of 9 extra files that come with CombatLib.aslx in the install zip file:</p>\n<pre><code>      if (game.pov.status = \"Merchant's Tongue\") {\n        rate = 75\n      }\n      else {\n        rate = 100\n      }\n      return (price * (rate + game.pov.parent.markup) / 100)\n  ]]&gt;&lt;/function&gt;```\n\n  &lt;!--\n  Sets the mark up for selling goods across the world to be their price attribute.\n  --&gt;\n  &lt;function name=\"SellingPrice\" parameters=\"price\" type=\"int\"&gt;&lt;![CDATA[\n      if (game.pov.status = \"Merchant's Tongue\") {\n        rate = 125\n      }\n      else {\n        rate = 100\n      }\n      return (price * (rate - game.pov.parent.markup) / 200)\n  ]]&gt;&lt;/function&gt;\n\nI had thought, when comparing this to ShopLib's aslx file, that CombatLib maybe had its own shop code, and so ShopLib wasn't needed. I uninstalled ShopLib and made a shop but the 'buy' command did nothing, so I reinstalled ShopLib, thinking I could copy the BuyingPrice code from ShopLib's aslx to overwrite that in CombatLib's. But I didn't need to in the end.\n\nThanks for all your help with this. Can't believe it was such a simple solution!\n</code></pre>\n\n",
      "PostDate": "2023-01-16T20:05:06.5833806Z",
      "LastEditDate": "2023-01-16T20:10:37.5000794Z",
      "link": null
    },
    {
      "PostId": "f471c9c8-c5a0-4089-9f20-40db008e9607",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "That looks like it's designed to work with a different version of shoplib… the parameter to `BuyingPrice` is the item's base price, rather than the object being bought. To make the \"Merchant's Tongue\" status effect work with ShopLib, it would need to be:\r\n\r\n<pre><code>  &lt;function name=\"BuyingPrice\" parameters=\"<i style=\"color: blue\">obj</i>\" type=\"int\">&lt;![CDATA[\r\n      if (game.pov.status = \"Merchant's Tongue\") {\r\n        rate = 75\r\n      }\r\n      else {\r\n        rate = 100\r\n      }\r\n      return (<i style=\"color: blue\">obj.</i>price * (rate + game.pov.parent.markup) / 100)\r\n  ]]>&lt;/function>```\r\n\r\n  &lt;function name=\"SellingPrice\" parameters=\"<i style=\"color: blue\">obj</i>\" type=\"int\">&lt;![CDATA[\r\n      if (game.pov.status = \"Merchant's Tongue\") {\r\n        rate = 125\r\n      }\r\n      else {\r\n        rate = 100\r\n      }\r\n      return (<i style=\"color: blue\">obj.</i>price * (rate - game.pov.parent.markup) / 200)\r\n  ]]>&lt;/function></code></pre>",
      "EditableFormat": "markdown",
      "HTML": "<p>That looks like it's designed to work with a different version of shoplib… the parameter to <code>BuyingPrice</code> is the item's base price, rather than the object being bought. To make the \"Merchant's Tongue\" status effect work with ShopLib, it would need to be:</p>\n<pre><code>  &lt;function name=\"BuyingPrice\" parameters=\"<i style=\"color: blue\">obj</i>\" type=\"int\"&gt;&lt;![CDATA[\n      if (game.pov.status = \"Merchant's Tongue\") {\n        rate = 75\n      }\n      else {\n        rate = 100\n      }\n      return (<i style=\"color: blue\">obj.</i>price * (rate + game.pov.parent.markup) / 100)\n  ]]&gt;&lt;/function&gt;```\n\n  &lt;function name=\"SellingPrice\" parameters=\"<i style=\"color: blue\">obj</i>\" type=\"int\"&gt;&lt;![CDATA[\n      if (game.pov.status = \"Merchant's Tongue\") {\n        rate = 125\n      }\n      else {\n        rate = 100\n      }\n      return (<i style=\"color: blue\">obj.</i>price * (rate - game.pov.parent.markup) / 200)\n  ]]&gt;&lt;/function&gt;</code></pre>\n\n",
      "PostDate": "2023-01-17T09:08:10.8285842Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "ca7ca8cd-8473-4c65-99e9-73ffa8017e25",
      "UserId": 614748,
      "Username": "Burgric",
      "AvatarUrl": "https://secure.gravatar.com/avatar/6900329662d740ad246206e33f62bb97?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Oh! I thought I downloaded the most recent versions of these libraries, from Pix's links. That makes sense now.\r\n\r\nThanks for the fix. I may change this code in the future if/when I implement the spell.\r\n\r\nI have since fixed another issue, and wonder if this is also because of a version incompatibility. The 'sell junk' command did not work as expected, as items flagged for 'destroy on sale' would technically 'sell', as the player was given money, but the item remained in the inventory and an error occurred with the dynamic template for 'selljunk'.\r\n\r\nI looked at the code featured in the error and found in the ShopLib file:\r\n\r\n(DynamicTemplate(\"SellSuccessful\", **obj**))\r\n              object.parent = null\r\n\r\nI changed this to:\r\n\r\n(DynamicTemplate(\"SellSuccessful\", **object**))\r\n              object.parent = null\r\n\r\nAnd it now works. Do you think this is to do with the version, also?",
      "EditableFormat": "markdown",
      "HTML": "<p>Oh! I thought I downloaded the most recent versions of these libraries, from Pix's links. That makes sense now.</p>\n<p>Thanks for the fix. I may change this code in the future if/when I implement the spell.</p>\n<p>I have since fixed another issue, and wonder if this is also because of a version incompatibility. The 'sell junk' command did not work as expected, as items flagged for 'destroy on sale' would technically 'sell', as the player was given money, but the item remained in the inventory and an error occurred with the dynamic template for 'selljunk'.</p>\n<p>I looked at the code featured in the error and found in the ShopLib file:</p>\n<p>(DynamicTemplate(\"SellSuccessful\", <strong>obj</strong>))<br>\nobject.parent = null</p>\n<p>I changed this to:</p>\n<p>(DynamicTemplate(\"SellSuccessful\", <strong>object</strong>))<br>\nobject.parent = null</p>\n<p>And it now works. Do you think this is to do with the version, also?</p>\n\n",
      "PostDate": "2023-01-18T18:54:04.4199294Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "9c20372a-9318-46f3-b180-98f658eae3b8",
      "UserId": 628400,
      "Username": "Lesternixon",
      "AvatarUrl": "https://secure.gravatar.com/avatar/a7cbd1ec5df7f7516dbbf7ce11f1ed7b?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I reinstalled the ShopLib library after uninstalling it. This was the answer, and I don't see how I could have overlooked something so obvious. I first looked at the BuyingPrice function and discovered the problematic expression before trying this. Before reinstalling it, I was curious as to how this interfered with ShopLib<a href=\"https://mybankinginformation.com/does-kroger-take-ebt-cards/\">.</a>",
      "EditableFormat": "markdown",
      "HTML": "<p>I reinstalled the ShopLib library after uninstalling it. This was the answer, and I don't see how I could have overlooked something so obvious. I first looked at the BuyingPrice function and discovered the problematic expression before trying this. Before reinstalling it, I was curious as to how this interfered with ShopLib<a href=\"https://mybankinginformation.com/does-kroger-take-ebt-cards/\">.</a></p>\n\n",
      "PostDate": "2023-01-29T15:57:59.7193043Z",
      "LastEditDate": "2023-01-29T15:58:49.7818649Z",
      "link": null
    }
  ]
}
