{
  "Topic": {
    "TopicId": "rayjr8hefkmyt-lz-5sabw",
    "ForumId": "10",
    "Title": "Global Before Leaving a room Script",
    "LastUpdated": "2017-09-06T02:34:43.7018809Z",
    "ReplyCount": 0
  },
  "Posts": [
    {
      "PostId": "61976a46-6492-4049-bd2c-a312ee7a43f8",
      "UserId": 227864,
      "Username": "Talon",
      "AvatarUrl": "https://secure.gravatar.com/avatar/3b6191c9adc337e83fec8e293e3fc584?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Is there a way to have a script fire right before anyone leaves a room, I'm trying to get a patrol NPCS that will interact with the player if they leave before the NPC does(Ie something like running from police)?",
      "EditableFormat": "markdown",
      "HTML": "<p>Is there a way to have a script fire right before anyone leaves a room, I'm trying to get a patrol NPCS that will interact with the player if they leave before the NPC does(Ie something like running from police)?</p>\n\n",
      "PostDate": "2017-09-06T02:34:43.7018809Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "aa7ebc7d-9050-4a35-a6b8-1d19e8fa7391",
      "UserId": 260569,
      "Username": "DarkLizerd",
      "AvatarUrl": "http://i.imgur.com/BXvaaIub.jpg",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "There is a \"Before entering the room\", but that would be connected to the next room.\r\nOr...\r\nYou could change the exit so that it runs a script instead of moving the player, then in that script, use that for the NPCs to interact with the player.\r\nJust use an \"if\" to let the player move normally, or stop the player from moving.\r\nThe you will need to add a MoveObject (player, next_room) to move the player.\r\n",
      "EditableFormat": "markdown",
      "HTML": "<p>There is a \"Before entering the room\", but that would be connected to the next room.<br>\nOr...<br>\nYou could change the exit so that it runs a script instead of moving the player, then in that script, use that for the NPCs to interact with the player.<br>\nJust use an \"if\" to let the player move normally, or stop the player from moving.<br>\nThe you will need to add a MoveObject (player, next_room) to move the player.</p>\n\n",
      "PostDate": "2017-09-06T03:39:57.9074023Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "8b6a7082-3dbd-4812-bcc5-9a4e46c3f851",
      "UserId": 227864,
      "Username": "Talon",
      "AvatarUrl": "https://secure.gravatar.com/avatar/3b6191c9adc337e83fec8e293e3fc584?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Hmm that doesn't  cover my problem really, I'd like it to work on any room, I suppose i could attach it to all the rooms in the game, but when thats around  200 or so atm, it feels really \"Wrong\" from a technical aspect",
      "EditableFormat": "markdown",
      "HTML": "<p>Hmm that doesn't  cover my problem really, I'd like it to work on any room, I suppose i could attach it to all the rooms in the game, but when thats around  200 or so atm, it feels really \"Wrong\" from a technical aspect</p>\n\n",
      "PostDate": "2017-09-09T02:37:28.9159193Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "33e7b498-eb33-4715-8fe5-ce7ba4d8e92b",
      "UserId": 260569,
      "Username": "DarkLizerd",
      "AvatarUrl": "http://i.imgur.com/BXvaaIub.jpg",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Then, it sounds like what you want is a function...\r\nBut what calls the function would be the question.\r\nUnder \r\n\\-Objects\r\n\\---game\r\nThere is a tab called \"Scripts\"\r\nThere is a Start script:\r\nScript when entering a room:\r\nand a Turn script:\r\nYou may want the turn script or the Script when entering a room\r\nand put your code there...\r\nThose sound like a global script things that you are looking for.\r\n",
      "EditableFormat": "markdown",
      "HTML": "<p>Then, it sounds like what you want is a function...<br>\nBut what calls the function would be the question.<br>\nUnder<br>\n-Objects<br>\n---game<br>\nThere is a tab called \"Scripts\"<br>\nThere is a Start script:<br>\nScript when entering a room:<br>\nand a Turn script:<br>\nYou may want the turn script or the Script when entering a room<br>\nand put your code there...<br>\nThose sound like a global script things that you are looking for.</p>\n\n",
      "PostDate": "2017-09-09T04:02:49.6638244Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "a301b568-8721-4e53-bf96-1025c4e8e8f7",
      "UserId": 318253,
      "Username": "K.V.",
      "AvatarUrl": "http://i.imgur.com/FOIjtApb.png",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "You could call a function from the script that moves the NPCs.  (I assume they don't move around on their own.  Ha-ha!)\r\n\r\nIf you post a sample of that script, we can most assuredly help you out.",
      "EditableFormat": "markdown",
      "HTML": "<p>You could call a function from the script that moves the NPCs.  (I assume they don't move around on their own.  Ha-ha!)</p>\n<p>If you post a sample of that script, we can most assuredly help you out.</p>\n\n",
      "PostDate": "2017-09-09T05:20:15.349755Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "cbc9802d-cdb9-4f07-9b40-a039c2edd4df",
      "UserId": 318253,
      "Username": "K.V.",
      "AvatarUrl": "http://i.imgur.com/FOIjtApb.png",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "...or...\r\n\r\nYou could make a Boolean attribute for each NPC that should be in the room with the player during said scene.  Call it ```gangmember``` and set it to ```true```.\r\n\r\n\r\nYou can enable this turn script or disable it, whenever you please:\r\n\r\n**TURN SCRIPT**\r\n\r\n```\r\nforeach (npc, AllObjects()) {\r\n  if (HasAttribute(npc, \"gangmember\")) {\r\n    if (npc.gangmember) {\r\n      if (not npc.parent = player.parent) {\r\n        msg (GetDisplayName(npc) + \" just made a break for it!\")\r\n        npc.gangmember = false\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n<div style=\"background:black;color:green;padding:12px\">\r\n<samp>\r\n\r\nYou are in a room.\r\nYou can see npc1 and npc2.\r\n\r\n\\> z\r\nTime passes.\r\n\r\n\\> z\r\nTime passes.\r\n\r\n\\> z\r\nTime passes.\r\n\r\n\\> z\r\nTime passes.\r\nnpc2 just made a break for it!\r\n\r\n\\> z\r\nTime passes.\r\n\r\n</samp>\r\n</div>",
      "EditableFormat": "markdown",
      "HTML": "<p>...or...</p>\n<p>You could make a Boolean attribute for each NPC that should be in the room with the player during said scene.  Call it <code>gangmember</code> and set it to <code>true</code>.</p>\n<p>You can enable this turn script or disable it, whenever you please:</p>\n<p><strong>TURN SCRIPT</strong></p>\n<pre><code>foreach (npc, AllObjects()) {\n  if (HasAttribute(npc, \"gangmember\")) {\n    if (npc.gangmember) {\n      if (not npc.parent = player.parent) {\n        msg (GetDisplayName(npc) + \" just made a break for it!\")\n        npc.gangmember = false\n      }\n    }\n  }\n}\n</code></pre>\n<div style=\"background: black; color: green; padding: 12px\">\n<samp>\n<p>You are in a room.<br>\nYou can see npc1 and npc2.</p>\n<p>&gt; z<br>\nTime passes.</p>\n<p>&gt; z<br>\nTime passes.</p>\n<p>&gt; z<br>\nTime passes.</p>\n<p>&gt; z<br>\nTime passes.<br>\nnpc2 just made a break for it!</p>\n<p>&gt; z<br>\nTime passes.</p>\n</samp>\n</div>\n\n",
      "PostDate": "2017-09-09T05:29:13.810353Z",
      "LastEditDate": "2017-09-09T05:35:10.4586884Z",
      "link": null
    },
    {
      "PostId": "d88f9b39-7f5e-4573-8391-68716be99d28",
      "UserId": 1346,
      "Username": "The Pixie",
      "AvatarUrl": "https://secure.gravatar.com/avatar/cfa37e927f96177bcf6053ae8f108f77?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Are you wanting this to fire when the player goes to a new room or an NPC?\r\n\r\nIf the player, then go to the _Scripts_ tab of the game object. There is a script there that runs whenever the player enters a new room.",
      "EditableFormat": "markdown",
      "HTML": "<p>Are you wanting this to fire when the player goes to a new room or an NPC?</p>\n<p>If the player, then go to the <em>Scripts</em> tab of the game object. There is a script there that runs whenever the player enters a new room.</p>\n\n",
      "PostDate": "2017-09-09T07:37:27.6291188Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "9729dd74-962b-47f0-877e-dfaa92558975",
      "UserId": 318253,
      "Username": "K.V.",
      "AvatarUrl": "http://i.imgur.com/FOIjtApb.png",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Oh, whoops!  Did I misread that?  (Sorry about that!)\r\n\r\n#### For the player:\r\n\r\n---\r\nThis script will add whatever script you put in place of ```msg (\"IT WORKS!\")```  to the **After exit** script on <strong>every room in the game</strong>:\r\n\r\nUPDATED:\r\n```\r\nforeach (o, AllObjects()) {\r\n  foreach (r, ScopeExitsForRoom(o)) {\r\n    o.enter => {\r\n      msg (\"Enter a script or message here! (scopeExits)\")\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\nIf you want it set to run after entering, substitute ```o.onexit``` with ```o.enter```.\r\n\r\nIf you want it set to run before entering, substitute ```o.onexit``` with ```o.beforeenter```.\r\n\r\n\r\nNOTE: **Before enter** - prints the message before printing the room description, and **after** prints it after (of course).  Point being, neither print the message before you actually leave the room.\r\n\r\n\r\n\r\n---\r\nI can't find a **Before exit** anywhere, but you can put this in the start script (instead of anything else), and it would make the player press any key between printing your message and actually moving the player to **any room** while ```game.copsAreComing = true```.  \r\n\r\nIf you don't have a Boolean attribute set on the game with the name ```copsAreComing``` set to true, it would move the player as it normally would.\r\n\r\n```\r\nexitScript => {\r\n  game.this = this\r\n  if (HasAttribute(game, \"copsAreComing\")) {\r\n    if (game.copsAreComing) {\r\n      msg (\"You have left while... whatever is going on is going on.<br><br>PRESS ANY KEY TO CONTINUE.\")\r\n      wait {\r\n        MoveObject (player, game.this.to)\r\n      }\r\n    }\r\n  }\r\n  else {\r\n    MoveObject (player, game.this.to)\r\n  }\r\n}\r\nforeach (o, AllExits()) {\r\n  o.runscript = true\r\n  o.script = exitScript\r\n}\r\n```",
      "EditableFormat": "markdown",
      "HTML": "<p>Oh, whoops!  Did I misread that?  (Sorry about that!)</p>\n<h4>For the player:</h4>\n<hr>\n<p>This script will add whatever script you put in place of <code>msg (\"IT WORKS!\")</code>  to the <strong>After exit</strong> script on <strong>every room in the game</strong>:</p>\n<p>UPDATED:</p>\n<pre><code>foreach (o, AllObjects()) {\n  foreach (r, ScopeExitsForRoom(o)) {\n    o.enter =&gt; {\n      msg (\"Enter a script or message here! (scopeExits)\")\n    }\n  }\n}\n</code></pre>\n<p>If you want it set to run after entering, substitute <code>o.onexit</code> with <code>o.enter</code>.</p>\n<p>If you want it set to run before entering, substitute <code>o.onexit</code> with <code>o.beforeenter</code>.</p>\n<p>NOTE: <strong>Before enter</strong> - prints the message before printing the room description, and <strong>after</strong> prints it after (of course).  Point being, neither print the message before you actually leave the room.</p>\n<hr>\n<p>I can't find a <strong>Before exit</strong> anywhere, but you can put this in the start script (instead of anything else), and it would make the player press any key between printing your message and actually moving the player to <strong>any room</strong> while <code>game.copsAreComing = true</code>.</p>\n<p>If you don't have a Boolean attribute set on the game with the name <code>copsAreComing</code> set to true, it would move the player as it normally would.</p>\n<pre><code>exitScript =&gt; {\n  game.this = this\n  if (HasAttribute(game, \"copsAreComing\")) {\n    if (game.copsAreComing) {\n      msg (\"You have left while... whatever is going on is going on.&lt;br&gt;&lt;br&gt;PRESS ANY KEY TO CONTINUE.\")\n      wait {\n        MoveObject (player, game.this.to)\n      }\n    }\n  }\n  else {\n    MoveObject (player, game.this.to)\n  }\n}\nforeach (o, AllExits()) {\n  o.runscript = true\n  o.script = exitScript\n}\n</code></pre>\n\n",
      "PostDate": "2017-09-09T08:50:20.187178Z",
      "LastEditDate": "2017-09-09T11:46:09.3343697Z",
      "link": null
    },
    {
      "PostId": "c535eb34-67e6-4b72-b4e2-d8cd4e169aa8",
      "UserId": 1346,
      "Username": "The Pixie",
      "AvatarUrl": "https://secure.gravatar.com/avatar/cfa37e927f96177bcf6053ae8f108f77?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "You should not use the various editor types, such as `editor_room`, in your game, as Quest will strip them out when you publish. They are there purely tolet Quest know which tabs to display. Best way to check if an object is a room is probably to see if it has any exits or to check if it has a `description` attribute.",
      "EditableFormat": "markdown",
      "HTML": "<p>You should not use the various editor types, such as <code>editor_room</code>, in your game, as Quest will strip them out when you publish. They are there purely tolet Quest know which tabs to display. Best way to check if an object is a room is probably to see if it has any exits or to check if it has a <code>description</code> attribute.</p>\n\n",
      "PostDate": "2017-09-09T10:15:58.7835152Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "ca8a80ad-7dd5-4f4f-af08-0c2ada89244c",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "@K.V.\r\nThe first code block you game makes me wonder; the documentation says that the ```editor_room``` type is only used within the editor, and is removed when the game is published. So would publishing stop that script from working? That's what I assumed when I was previously looking for a way to distinguish rooms from other objects.",
      "EditableFormat": "markdown",
      "HTML": "<p>@K.V.<br>\nThe first code block you game makes me wonder; the documentation says that the <code>editor_room</code> type is only used within the editor, and is removed when the game is published. So would publishing stop that script from working? That's what I assumed when I was previously looking for a way to distinguish rooms from other objects.</p>\n\n",
      "PostDate": "2017-09-09T10:16:21.2874246Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "fd38fb6f-7b50-4996-b41e-a2eeb11a8015",
      "UserId": 318253,
      "Username": "K.V.",
      "AvatarUrl": "http://i.imgur.com/FOIjtApb.png",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Ha!\r\n\r\nI wish I could see those posts' times, down to the second!\r\n\r\n---\r\nThanks!\r\n\r\nThe whole ```editor_``` part should have been a dead giveaway, huh?\r\n\r\nI'm on it, though!  Taking the check-for-exit route, just in case a description doesn't exist.\r\n\r\n<s>I'll be back to edit things...</s>\r\n\r\nI edited that bit.\r\n\r\n---\r\n(I'd have NEVER figured out why that disappeared on my own!)",
      "EditableFormat": "markdown",
      "HTML": "<p>Ha!</p>\n<p>I wish I could see those posts' times, down to the second!</p>\n<hr>\n<p>Thanks!</p>\n<p>The whole <code>editor_</code> part should have been a dead giveaway, huh?</p>\n<p>I'm on it, though!  Taking the check-for-exit route, just in case a description doesn't exist.</p>\n<p><s>I'll be back to edit things...</s></p>\n<p>I edited that bit.</p>\n<hr>\n<p>(I'd have NEVER figured out why that disappeared on my own!)</p>\n\n",
      "PostDate": "2017-09-09T11:32:57.0234806Z",
      "LastEditDate": "2017-09-09T11:48:39.8945454Z",
      "link": null
    },
    {
      "PostId": "cc082fc7-17c0-4101-8cbb-55b9f92a8a09",
      "UserId": 255368,
      "Username": "DarkBlueMonkey",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "I have a very similar requirement.. If I'm in a fight, I want the NPC enemies to get added to a list of monsters which are \"following\" the player... Then on a timer, the monsters move \"towards\" the player... I do this by keeping track of the rooms the player's in, and adding it to the \"follow\" list of any monsters  that are following the player...\r\n\r\nOK, so to do it, I thought about one of two ways:\r\n\r\n1. Create a \"gameroom\" base type, and ensure that all rooms are inherited from it.. In this \"gameroom\", I set the onexit to do my bidding... which will be inherited by all rooms.\r\n\r\n2. Create a game script attribute (called globalroomexitscript) with my logic, then  create another script which runs right at the beginning of the game which goes\r\n\r\nforeach(room, AllRooms()) {\r\n  room.onexit  = game.globalroomexitscript\r\n}\r\nor something similar....\r\n\r\nIn the end I went with the inheritance route, because that fit better with how I was controlling everything else :)\r\n\r\nHope that helps!",
      "EditableFormat": "markdown",
      "HTML": "<p>I have a very similar requirement.. If I'm in a fight, I want the NPC enemies to get added to a list of monsters which are \"following\" the player... Then on a timer, the monsters move \"towards\" the player... I do this by keeping track of the rooms the player's in, and adding it to the \"follow\" list of any monsters  that are following the player...</p>\n<p>OK, so to do it, I thought about one of two ways:</p>\n<ol>\n<li>\n<p>Create a \"gameroom\" base type, and ensure that all rooms are inherited from it.. In this \"gameroom\", I set the onexit to do my bidding... which will be inherited by all rooms.</p>\n</li>\n<li>\n<p>Create a game script attribute (called globalroomexitscript) with my logic, then  create another script which runs right at the beginning of the game which goes</p>\n</li>\n</ol>\n<p>foreach(room, AllRooms()) {<br>\nroom.onexit  = game.globalroomexitscript<br>\n}<br>\nor something similar....</p>\n<p>In the end I went with the inheritance route, because that fit better with how I was controlling everything else :)</p>\n<p>Hope that helps!</p>\n\n",
      "PostDate": "2017-09-11T13:28:10.7752634Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "2b4a1f93-92ff-4c95-bb79-0ae5d5ffdb8d",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "You could also modify the `player.changedparent` script attribute, which is run whenever the player moves to another room.\r\n\r\nBy default, it is set to:\r\n```\r\n      if (game.pov = this) {\r\n        if (IsDefined(\"oldvalue\")) {\r\n          OnEnterRoom(oldvalue)\r\n        }\r\n        else {\r\n          OnEnterRoom(null)\r\n        }\r\n        if (game.gridmap) {\r\n          MergePOVCoordinates\r\n        }\r\n      }\r\n      this.hasbeenmoved = true\r\n```\r\n\r\nYou could override that and add your own functionality there.\r\n\r\n(The function `OnEnterRoom(oldroom)` is responsible for calling the onexit script of the old room, and the onenter script for the new one, and printing the new room's description)",
      "EditableFormat": "markdown",
      "HTML": "<p>You could also modify the <code>player.changedparent</code> script attribute, which is run whenever the player moves to another room.</p>\n<p>By default, it is set to:</p>\n<pre><code>      if (game.pov = this) {\n        if (IsDefined(\"oldvalue\")) {\n          OnEnterRoom(oldvalue)\n        }\n        else {\n          OnEnterRoom(null)\n        }\n        if (game.gridmap) {\n          MergePOVCoordinates\n        }\n      }\n      this.hasbeenmoved = true\n</code></pre>\n<p>You could override that and add your own functionality there.</p>\n<p>(The function <code>OnEnterRoom(oldroom)</code> is responsible for calling the onexit script of the old room, and the onenter script for the new one, and printing the new room's description)</p>\n\n",
      "PostDate": "2017-09-11T13:38:46.3988041Z",
      "LastEditDate": null,
      "link": null
    },
    {
      "PostId": "72b3909e-2ee7-4e41-88c0-2dfc38202801",
      "UserId": 227864,
      "Username": "Talon",
      "AvatarUrl": "https://secure.gravatar.com/avatar/3b6191c9adc337e83fec8e293e3fc584?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Those were some big help KV..and i learned alot of what the start script could do.  Initially I thought it fixed up everything..however noticed some odd bugs, then i realized what the code was doing, changing the \"Before enter\" scripts i had already placed in various rooms as well(for random flavor texts dedicated to the room)\r\n\r\nSorry about being so slow to  reply, was trying to figure out why these bugs were happening on my own first, \r\n\r\nedit- though far from perfect, managed to get something working by having the timer add a player flag when the officer enters their room, and removes it when they leave(just checking parents), mixing this with a turnscript on the game that checks for the presence, if its there the script fires.. it won't work if the player stumbles on the officer mid path, but pretty functional otherwise",
      "EditableFormat": "markdown",
      "HTML": "<p>Those were some big help KV..and i learned alot of what the start script could do.  Initially I thought it fixed up everything..however noticed some odd bugs, then i realized what the code was doing, changing the \"Before enter\" scripts i had already placed in various rooms as well(for random flavor texts dedicated to the room)</p>\n<p>Sorry about being so slow to  reply, was trying to figure out why these bugs were happening on my own first,</p>\n<p>edit- though far from perfect, managed to get something working by having the timer add a player flag when the officer enters their room, and removes it when they leave(just checking parents), mixing this with a turnscript on the game that checks for the presence, if its there the script fires.. it won't work if the player stumbles on the officer mid path, but pretty functional otherwise</p>\n\n",
      "PostDate": "2017-09-18T04:33:01.2129101Z",
      "LastEditDate": "2017-09-18T10:39:09.2898995Z",
      "link": null
    }
  ]
}
