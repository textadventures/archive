{
  "Topic": {
    "TopicId": "bmqdnomheeyuo9yop4ymba",
    "ForumId": "10",
    "Title": "WhenReady",
    "LastUpdated": "2018-08-31T08:14:56.2142002Z",
    "ReplyCount": 0
  },
  "Posts": [
    {
      "PostId": "66c0cc1d-18bf-44c5-869b-81c279d7cad0",
      "UserId": 319917,
      "Username": "mrangel",
      "AvatarUrl": "https://secure.gravatar.com/avatar/?d=retro",
      "UserAvatar": null,
      "UserGravatar": null,
      "EditableText": "Random thoughts off the top of my head. Woke up with this in my head this morning.\r\n\r\nIt's a function that operates like `on ready {`, but you can call it more than once to queue up multiple scripts.\r\n```\r\n<function name=\"WhenReady\" parameters=\"params, script\">\r\n  if (not IsDefined(\"params\")) {\r\n    params = NewDictionary()\r\n  }\r\n  if (TypeOf (params) = \"script\" and not TypeOf(script) = \"script\") {\r\n    // allow parameters in either order, for convenience\r\n    temp = params\r\n    params = script\r\n    script = temp\r\n  }\r\n  if (not HasAttribute (game, \"readyqueue\")) {\r\n    game.readyqueue = NewList()\r\n    whenready.enabled = true\r\n  }\r\n  if (GetBoolean (whenready, \"isrunning\") and ListCount(game.readyqueue) > 0) {\r\n    // When a script is running, we likely want a newly-added one to run immediately\r\n    newlist = NewList()\r\n    list add (newlist, QuickParams (\"script\", script, \"params\", params))\r\n    game.readyqueue = ListCombine (newlist, game.readyqueue)\r\n  }\r\n  else {\r\n    list add (game.readyqueue, QuickParams (\"script\", script, \"params\", params))\r\n  }\r\n</function>\r\n\r\n<function name=\"RedoThis\">\r\n  if (HasAttribute (game, \"readyinvokedmenu\")) {\r\n    newlist = NewList()\r\n    list add (newlist, game.readyinvokedmenu)\r\n    if (HasAttribute (game, \"readyqueue\")) {\r\n      newlist = ListCombine (newlist, game.readyqueue)\r\n    }\r\n    game.readyqueue = newlist\r\n  }\r\n  else {\r\n    game.redothis = true\r\n  }\r\n</function>\r\n\r\n<turnscript name=\"whenready\">\r\n  <enabled />\r\n  <script>\r\n  on ready {\r\n    this.isrunning = true\r\n    if (HasAttribute (game, \"readyqueue\") and not HasAttribute(game, \"menucallback\")) {\r\n      hash = ListItem (game.readyqueue, 0)\r\n      invoke (DictionaryItem (hash, \"script\"), DictionaryItem (hash, \"params\"))\r\n      if (HasScript (game, \"menucallback\")) {\r\n        game.readyinvokedmenu = hash\r\n      }\r\n      else {\r\n        game.readyinvokedmenu = null\r\n      }\r\n      if (GetBoolean (game, \"redothis\")) {\r\n        game.redothis = null\r\n      }\r\n      else {\r\n        list remove (game.readyqueue, hash)\r\n        if (ListCount (game.readyqueue) = 0) {\r\n          game.readyqueue = null\r\n          this.enabled = false\r\n        }\r\n      }\r\n      do (this, \"script\")\r\n    }\r\n    this.isrunning = false\r\n  }\r\n  </script>\r\n</turnscript>\r\n```\r\n\r\nExample usage:\r\n```\r\nWhenReady() {\r\n  ShowMenu (\"What is your favourite colour?\", Split(\"red;green;blue;yellow\"), false) {\r\n    player.colour = result\r\n    if (result = \"yellow\") {\r\n      WhenReady {\r\n        Ask (\"Would you like a banana?\") {\r\n          if (result) {\r\n            msg (\"Well, tough. This was just an example to show that you can nest calls to WhenReady.\")\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\nWhenReady() {\r\n  ShowMenu (\"What is your favourite cheese?\", Split(\"cheddar;swiss;blue;brunost;edam\"), false) {\r\n    player.cheese = result\r\n  }\r\n}\r\nWhenReady() {\r\n  ShowMenu (\"Is there any point in this?\", Split(\"no;not really;yes;fish\"), false) {\r\n    if (result = \"fish\") {\r\n      msg (\"Stupid answer! Try again!\")\r\n      RedoThis()\r\n    }\r\n    else {\r\n      msg (\"I quite agree!\")\r\n    }\r\n  }\r\n}\r\nWhenReady() {\r\n  msg (\"Thanks for answering the questions!\")\r\n  finish()\r\n}\r\n```\r\n\r\n(This was just off the top of my head, not tested yet. But wondered if it would give anyone some ideas)",
      "EditableFormat": "markdown",
      "HTML": "<p>Random thoughts off the top of my head. Woke up with this in my head this morning.</p>\n<p>It's a function that operates like <code>on ready {</code>, but you can call it more than once to queue up multiple scripts.</p>\n<pre><code>&lt;function name=\"WhenReady\" parameters=\"params, script\"&gt;\n  if (not IsDefined(\"params\")) {\n    params = NewDictionary()\n  }\n  if (TypeOf (params) = \"script\" and not TypeOf(script) = \"script\") {\n    // allow parameters in either order, for convenience\n    temp = params\n    params = script\n    script = temp\n  }\n  if (not HasAttribute (game, \"readyqueue\")) {\n    game.readyqueue = NewList()\n    whenready.enabled = true\n  }\n  if (GetBoolean (whenready, \"isrunning\") and ListCount(game.readyqueue) &gt; 0) {\n    // When a script is running, we likely want a newly-added one to run immediately\n    newlist = NewList()\n    list add (newlist, QuickParams (\"script\", script, \"params\", params))\n    game.readyqueue = ListCombine (newlist, game.readyqueue)\n  }\n  else {\n    list add (game.readyqueue, QuickParams (\"script\", script, \"params\", params))\n  }\n&lt;/function&gt;\n\n&lt;function name=\"RedoThis\"&gt;\n  if (HasAttribute (game, \"readyinvokedmenu\")) {\n    newlist = NewList()\n    list add (newlist, game.readyinvokedmenu)\n    if (HasAttribute (game, \"readyqueue\")) {\n      newlist = ListCombine (newlist, game.readyqueue)\n    }\n    game.readyqueue = newlist\n  }\n  else {\n    game.redothis = true\n  }\n&lt;/function&gt;\n\n&lt;turnscript name=\"whenready\"&gt;\n  &lt;enabled /&gt;\n  &lt;script&gt;\n  on ready {\n    this.isrunning = true\n    if (HasAttribute (game, \"readyqueue\") and not HasAttribute(game, \"menucallback\")) {\n      hash = ListItem (game.readyqueue, 0)\n      invoke (DictionaryItem (hash, \"script\"), DictionaryItem (hash, \"params\"))\n      if (HasScript (game, \"menucallback\")) {\n        game.readyinvokedmenu = hash\n      }\n      else {\n        game.readyinvokedmenu = null\n      }\n      if (GetBoolean (game, \"redothis\")) {\n        game.redothis = null\n      }\n      else {\n        list remove (game.readyqueue, hash)\n        if (ListCount (game.readyqueue) = 0) {\n          game.readyqueue = null\n          this.enabled = false\n        }\n      }\n      do (this, \"script\")\n    }\n    this.isrunning = false\n  }\n  &lt;/script&gt;\n&lt;/turnscript&gt;\n</code></pre>\n<p>Example usage:</p>\n<pre><code>WhenReady() {\n  ShowMenu (\"What is your favourite colour?\", Split(\"red;green;blue;yellow\"), false) {\n    player.colour = result\n    if (result = \"yellow\") {\n      WhenReady {\n        Ask (\"Would you like a banana?\") {\n          if (result) {\n            msg (\"Well, tough. This was just an example to show that you can nest calls to WhenReady.\")\n          }\n        }\n      }\n    }\n  }\n}\nWhenReady() {\n  ShowMenu (\"What is your favourite cheese?\", Split(\"cheddar;swiss;blue;brunost;edam\"), false) {\n    player.cheese = result\n  }\n}\nWhenReady() {\n  ShowMenu (\"Is there any point in this?\", Split(\"no;not really;yes;fish\"), false) {\n    if (result = \"fish\") {\n      msg (\"Stupid answer! Try again!\")\n      RedoThis()\n    }\n    else {\n      msg (\"I quite agree!\")\n    }\n  }\n}\nWhenReady() {\n  msg (\"Thanks for answering the questions!\")\n  finish()\n}\n</code></pre>\n<p>(This was just off the top of my head, not tested yet. But wondered if it would give anyone some ideas)</p>\n\n",
      "PostDate": "2018-08-31T08:14:56.2142002Z",
      "LastEditDate": null,
      "link": null
    }
  ]
}
